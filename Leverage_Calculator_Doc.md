# 杠杆交易复利计算器 — 技术文档

> 最终版本 · 2026-02-17

---

## 1. 项目概述

一个纯前端（HTML + CSS + JS）的单页应用，用于模拟杠杆交易的复利/非复利收益、爆仓风险和逐笔交易明细。用户输入基础参数和交易序列后，一键生成：

- 总结卡片（最终净值、总盈亏、平均实际杠杆、最小可回调空间）
- 账户收益率曲线（Chart.js 折线图）
- 逐笔交易明细表（含方向、手数、保证金、盈亏、爆仓价等）

---

## 2. 文件结构

```
leverage_calculator/
├── index.html          # 页面结构与品种数据
├── style.css           # 暗色主题样式
├── calculator.js       # 计算引擎 + UI 控制逻辑
└── Leverage_Calculator_Doc.md   # 本文档
```

外部依赖：`Chart.js v4`（CDN 引入）

---

## 3. 输入参数

| 参数 | 默认值 | 说明 |
|------|--------|------|
| 初始本金 | $1,000 | 账户起始资金 (USD) |
| 杠杆倍数 | 400x | 经纪商提供的杠杆比例 |
| 交易品种 | XAGUSD (白银) | 下拉选择，自动填充合约面值与最小手数步进 |
| 最小手数步进 | 跟随品种 | 只读，由品种 `data-step` 属性驱动；选择"自定义品种"时解锁 |
| 持仓比例 | 5% | 滑动条 + 数字输入框双向联动，范围 1–100% |
| 复利模式 | 开启 | 开启时每笔盈利计入下一笔建仓基数 |

### 3.1 支持的交易品种（含合约面值与手数步进）

| 分类 | 品种示例 | 合约面值 | 最小手数 |
|------|----------|----------|----------|
| 贵金属 | XAUUSD, XAGUSD, XPTUSD, XPDUSD | 100 / 5000 盎司 | 0.01 |
| 外汇主要 | EURUSD, GBPUSD, USDJPY 等 7 对 | 100,000 单位 | 0.01 |
| 外汇交叉 | EURGBP, GBPJPY, AUDJPY 等 18 对 | 100,000 单位 | 0.01 |
| 能源 | USOIL, UKOIL | 1,000 桶 | 0.01 |
| 能源 | NGAS | 10,000 mmBtu | 0.1 |
| 股指 CFD | US30, US500, USTEC, GER40 等 10 种 | 1 ($/点/手) | 0.1 |
| 加密货币 | BTCUSD, ETHUSD, LTCUSD, XRPUSD | 1 | 0.01 |
| 自定义 | 手动输入 | 用户自定义 | 用户自定义 |

---

## 4. 交易序列

### 4.1 输入模式

- **按价格输入**：每行填写入场价和出场价
- **按涨跌幅输入**：每行填写入场价和涨跌幅百分比

### 4.2 每笔独立方向

每笔交易行前有 **多/空** 下拉选择器，支持在同一序列中混合做多和做空。

- 做多：出场价 > 入场价时盈利
- 做空：出场价 < 入场价时盈利
- 涨跌幅模式下，做多时 `出场价 = 入场价 × (1 + 涨跌幅%)`，做空时 `出场价 = 入场价 × (1 - 涨跌幅%)`

### 4.3 默认状态

页面加载时预留一个空的交易行，无预填数据。

---

## 5. 核心计算引擎 (`LeverageCalculator`)

### 5.1 类结构

```javascript
class LeverageCalculator {
  constructor(params)        // 初始化参数
  floorToStep(value)         // 将手数向下取整到最小步进
  calcTrade(balance, entry, exit, direction)  // 单笔交易计算
  run(trades)                // 执行完整交易序列
}
```

### 5.2 单笔交易计算公式

| 指标 | 公式 |
|------|------|
| 建仓资金 | `Capital = Balance × MarginRatio%` |
| 原始手数 | `RawLots = Capital × Leverage / (ContractSize × EntryPrice)` |
| 实际手数 | `Lots = max(LotStep, floor(RawLots / LotStep) × LotStep)` |
| 持仓单位 | `Units = Lots × ContractSize` |
| 保证金 | `Margin = Units × EntryPrice / Leverage` |
| 合约价值 | `ContractValue = Units × EntryPrice` |
| 实际杠杆 | `EffectiveLeverage = ContractValue / Balance` |
| 盈亏 (做多) | `P&L = Units × (ExitPrice − EntryPrice)` |
| 盈亏 (做空) | `P&L = Units × (EntryPrice − ExitPrice)` |
| 盈亏百分比 | `P&L% = P&L / Balance × 100` |
| 可用保证金 | `FreeMargin = Balance − Margin` |
| 最大可回调价格 | `MaxDD$ = FreeMargin / Units` |
| 最大可回调百分比 | `MaxDD% = MaxDD$ / EntryPrice × 100` |
| 爆仓价 (做多) | `LiquidationPrice = EntryPrice − MaxDD$` |
| 爆仓价 (做空) | `LiquidationPrice = EntryPrice + MaxDD$` |

### 5.3 复利 vs 非复利

- **复利模式**：`Balance_next = Balance_current + P&L`（盈利滚入下一笔）
- **非复利模式**：`Balance = Principal + Σ(所有已完成交易的 P&L)`

---

## 6. 持仓比例与手数预览

持仓比例控件由滑动条 + 数字输入框组成，双向实时联动。下方显示手数预览：

```
持仓资金 $50.00 · ≈ 0.14 手
```

手数预览根据以下参数实时更新：
- 初始本金、杠杆倍数、交易品种（合约面值）、最小手数步进、持仓比例
- 第一笔交易的入场价（未输入时提示"需输入入场价计算手数"）

---

## 7. 输出结果

### 7.1 总结卡片

| 卡片 | 内容 |
|------|------|
| 最终净值 | 最终账户余额 + 总收益率% |
| 总盈亏 | 总利润/亏损金额 + 交易笔数 |
| 平均实际杠杆 | 所有交易实际杠杆的平均值 |
| 最小可回调空间 | 所有交易中最危险的一笔的可回调百分比 |

### 7.2 账户收益率曲线

Chart.js 折线图，X 轴为交易序号（初始 → 第N笔），Y 轴为账户净值。

### 7.3 逐笔交易明细表

14 列：序号、方向、入场→出场、交易前余额、手数、保证金、合约价值、实际杠杆、盈亏、盈亏%、可回调$、可回调%、爆仓价、交易后余额。

- 方向列：做多绿色、做空红色
- 盈亏列：正值绿色、负值红色

---

## 8. UI 设计

### 8.1 布局

- 左右双栏布局（960px 以下自动切换为单栏）
- 左侧 380px 输入面板，右侧自适应结果面板

### 8.2 主题

暗色主题，配色方案：

| 变量 | 色值 | 用途 |
|------|------|------|
| `--bg` | `#0f1117` | 页面背景 |
| `--surface` | `#1a1d27` | 面板背景 |
| `--surface2` | `#232734` | 卡片/表头背景 |
| `--accent` | `#4f8cff` | 主强调色 |
| `--green` | `#22c55e` | 盈利/做多 |
| `--red` | `#ef4444` | 亏损/做空 |
| `--yellow` | `#eab308` | 警告（回调空间） |

### 8.3 交互特性

- 品种选择自动联动合约面值、最小手数步进、品种信息提示
- 持仓比例滑动条与数字输入框双向同步
- 手数预览实时更新
- 交易行可动态添加/删除/清空
- 价格输入与涨跌幅输入两种模式可切换，切换时保留已输入数据
- 核心公式栏已隐藏（`display:none`），代码保留可随时恢复

---

## 9. 版本演进记录

| 版本 | 变更内容 |
|------|----------|
| v1 | 基础计算器：固定全局方向（做多/做空），Python 脚本计算白银复利 |
| v2 | 迁移为 Web UI（HTML/CSS/JS），加入 Chart.js 图表、暗色主题 |
| v3 | 品种下拉列表替代手动输入合约面值，覆盖 MT4 全品种 |
| v4 | 每笔交易独立方向选择（多/空），移除全局方向控件 |
| v5 | 持仓比例支持滑动条 + 数字输入双向联动，实时手数预览 |
| v6 | 默认本金 $1,000、默认持仓比例 5%、最小手数步进跟随品种联动 |
| v7 (当前) | 交易序列默认空行、图表标题改为"账户收益率曲线"、隐藏核心公式栏 |

---

## 10. 使用方式

1. 直接用浏览器打开 `index.html`（无需服务器）
2. 设置基础参数（本金、杠杆、品种、持仓比例）
3. 在交易序列中添加交易，每笔选择做多或做空，填入入场价和出场价
4. 点击"计算"按钮查看结果

---

*仅供学习研究，不构成投资建议。实际交易中请注意滑点、点差、隔夜利息等额外成本。*
